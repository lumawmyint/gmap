<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receipt Auto Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 20px;
        }

        .container {
            display: flex;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        #receiptCanvas {
            border: 1px solid #ccc;
            image-rendering: crisp-edges;
            image-rendering: -webkit-optimize-contrast;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 250px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        input {
            padding: 6px;
            width: 120px;
        }

        button {
            padding: 8px 12px;
            cursor: pointer;
        }

        /* Smart Popup Styling */
        .popup {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .popup.show {
            opacity: 1;
        }
    </style>
</head>

<body>

    <h2>Receipt Auto Editor</h2>

    <div class="container">
        <canvas id="receiptCanvas" width="499" height="1080"></canvas>

        <div class="controls">
            <div class="control-group">
                <label>Time (HH:MM): <input type="text" id="timeInput"></label>
                <label>Date (DD Mon YYYY): <input type="text" id="dateInput"></label>
                <label>UTR: <input type="text" id="utrInput"></label>
            </div>

            <div class="control-group">
                <button onclick="updateReceipt()">Update Receipt</button>
                <button onclick="copyImage()">Copy Receipt</button>
            </div>
        </div>
    </div>

    <!-- Smart Popup (hidden by default) -->
    <div id="copyPopup" class="popup">Receipt copied successfully!</div>

    <script>
        // === CONFIG ===
        const baseUtrToday = 522331250026; // UTR for base date
        const baseDate = new Date(2025, 7, 11); // August 11, 2025 (month index 7)

        const canvas = document.getElementById('receiptCanvas');
        const ctx = canvas.getContext('2d');
        const copyPopup = document.getElementById('copyPopup');

        // === COORDINATES FROM YOUR MEASUREMENTS ===
            const coords = {
                time: { x: 41, y: 29, fontSize: 20.5 },
                date: { x: 351, y: 649, fontSize: 19 },
                utr: { x: 360, y: 715, fontSize: 14.5 }
            };

        // === LOAD TEMPLATE ===
        const templateImg = new Image();
        templateImg.src = 'template.png'; // Replace with your template PNG
        templateImg.onload = () => {
            fillInitialData();
        };

        function formatTime(date) {
            let hours = date.getHours();
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function fillInitialData() {
            const now = new Date();
            const diffDays = Math.floor((now - baseDate) / (1000 * 60 * 60 * 24));
            const utrToday = baseUtrToday + diffDays * 1000000;

            document.getElementById('timeInput').value = formatTime(now);
            document.getElementById('dateInput').value =
                now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            document.getElementById('utrInput').value = utrToday;

            updateReceipt();
        }

        function updateReceipt() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(templateImg, 0, 0, canvas.width, canvas.height);

            ctx.fillStyle = "#000";
            ctx.textAlign = "left";
            ctx.textBaseline = "top";

            // Time - with Microsoft YaHei (bold)
            ctx.font = `bold ${coords.time.fontSize}px "Microsoft YaHei", "微软雅黑", Arial, sans-serif`;
            ctx.fillText(document.getElementById('timeInput').value, coords.time.x, coords.time.y);

            // Date (keep original font)
            ctx.font = `${coords.date.fontSize}px Arial`;
            ctx.fillText(document.getElementById('dateInput').value, coords.date.x, coords.date.y);

            // UTR (keep original font)
            ctx.font = `${coords.utr.fontSize}px Arial`;
            ctx.fillText(document.getElementById('utrInput').value, coords.utr.x, coords.utr.y);
        }

        // Show temporary popup
        function showPopup() {
            copyPopup.classList.add('show');
            setTimeout(() => {
                copyPopup.classList.remove('show');
            }, 1500); // Hide after 1.5 seconds
        }

        async function copyImage() {
            try {
                canvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        showPopup(); // Show smart popup instead of alert
                    } catch (err) {
                        alert("Failed to copy: " + err);
                    }
                });
            } catch (err) {
                alert("Your browser doesn't support this feature. Please take a screenshot instead.");
            }
        }
    </script>

</body>

</html>